# スレッドについて

## スレッドについて調べたこと

スレッドはシステムコールか割り込みが呼ばれたときに行われる。

- 次に動作すべきスレッドの選択：スケジューリング
- 選択されたスレッドの再開：ディスパッチ

スタックはスレッドごとに持っている必要がある。

ディスパッチの時にスタックポインタを再開するスレッドのスタックのものに置き換える。

処理再開にCPUが必要とする情報をコンテキストと呼ぶ。

コンテキストは言ってしまえば各種レジスタのこと。

## Linux v0.01のタスクスケジューラについて

タスクを管理する配列がそのままランキュー(長さは64)

タイムスライスは固定150ms

curentのタイムスライス切れ or 全タスクがsleepならスケジューラを呼ぶ

ランキューを全捜査して残りタイムスライスが最大のものを次に動かす

該当者がいなければ全タスクのタイムスライスをリセット

タイムスライスが切れているタスクには150ms与える

sleep中のタスクには残りタイムスライス/2をボーナスとして与える

## スレッドの実装

- スタックの保存
    - スレッドごとに固定配列をもたせる？
- レジスタの保存
    - スレッドのスタックに保存しておく、rspだけはthread構造体で管理しておく？
- 周期タイマ
    - タイマ割り込み関数内で周期を数える
- スケジューラ呼び出し
    - 周期タイマで一定の周期を数え、周期が来たら周期タイマ内でスケジューラを呼び出す
- thread_run()内のメイン関数呼び出しについて
    - #PFで落ちる。原因 is 何？
